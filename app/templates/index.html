<!doctype html>
<html lang="fr">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calculateur d‚ÄôEmpreinte Carbone</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
</head>

<body>
  <main class="container">
    <header class="header">
      <h1>üåç Calculateur d‚ÄôEmpreinte Carbone</h1>
      <p class="sub">Mix √©lectrique (2015) + facteurs d‚Äô√©missions (m√©dianes IPCC 2014).</p>
    </header>

    {# Optional info messages from backend #}
    {% if db_error %}
    <section class="alert alert-error">
      <strong>Base de donn√©es indisponible</strong><br />
      <span>{{ db_error }}</span>
      <div class="small">
        V√©rifie que MySQL tourne, que la DB <code>carbonfootprint</code> existe, et lance
        <code>python scripts/init_mysql.py</code>.
      </div>
    </section>
    {% endif %}

    {% if choice_note %}
    <section class="alert alert-info">
      <strong>Info :</strong> {{ choice_note }}
    </section>
    {% endif %}
    {% if preview_note %}
    <section class="alert alert-info">
      <strong>Info :</strong> {{ preview_note }}
    </section>
    {% endif %}

    <section class="card">
      <form method="post" class="form">
        <div class="row">
          <label for="mode">Mode</label>

          <!-- ‚úÖ Auto-refresh list when mode changes -->
          <select id="mode" name="mode" onchange="this.form.submit()">
            <option value="Country" {% if mode=='Country' %}selected{% endif %}>Pays</option>
            <option value="World" {% if mode=='World' %}selected{% endif %}>R√©gion / Continent</option>
          </select>

          <small class="hint">
            Change de mode pour charger la liste (pays ou r√©gions).
          </small>
        </div>

        <div class="row">
          <label for="selected">S√©lection</label>

          {% if choices and choices|length > 0 %}
          <select id="selected" name="selected" required>
            {% for c in choices %}
            <option value="{{ c }}" {% if selected==c %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
          </select>
          {% else %}
          <div class="empty">
            Aucune donn√©e disponible pour ce mode.
            <div class="small">
              Lance <code>python scripts/init_mysql.py</code> ou v√©rifie ta DB <code>carbonfootprint</code>.
            </div>
          </div>
          {% endif %}
        </div>

        <div class="row">
          <label for="kw">Puissance consomm√©e (kW) en continu</label>
          <input id="kw" name="kw" type="number" step="0.01" min="0.01" value="{{ kw or 1 }}" required />
          <small class="hint">Exemple de l‚Äô√©nonc√© : 1 kW</small>
        </div>

        <button class="btn" type="submit" {% if not choices or choices|length==0 %}disabled{% endif %}>
          Calculer
        </button>
      </form>
    </section>

    <section class="card">
      <div class="card-head">
        <h2>Aper√ßu du dataset ({{ "World" if mode=="World" else "Country" }})</h2>
        <span class="pill">{{ preview|length }} lignes</span>
      </div>

      {% if preview and preview|length > 0 %}
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              {% for k in preview[0].keys() %}
              <th>{{ k }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for r in preview %}
            <tr>
              {% for v in r.values() %}
              <td>{{ v }}</td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="empty">
        Aper√ßu indisponible : aucune ligne retourn√©e.
        <div class="small">
          V√©rifie que les tables <code>Country</code> / <code>World</code> contiennent des donn√©es
          (<code>SELECT COUNT(*)</code>).
        </div>
      </div>
      {% endif %}
    </section>

    {% if result %}
    <section class="card">
      <h2>R√©sultats ‚Äî {{ result.mode }} : {{ result.selected }}</h2>

      <div class="kpis">
        <div class="kpi">
          <div class="kpi-label">Intensit√© carbone</div>
          <div class="kpi-value">{{ "%.2f"|format(result.intensity_g_per_kwh) }} gCO‚ÇÇ/kWh</div>
        </div>

        <div class="kpi">
          <div class="kpi-label">√âmissions annuelles</div>
          <div class="kpi-value">{{ "%.2f"|format(result.annual_kg) }} kg CO‚ÇÇ/an</div>
        </div>

        <div class="kpi">
          <div class="kpi-label">Arbres pour compenser</div>
          <div class="kpi-value">{{ "%.1f"|format(result.trees) }}</div>
        </div>
      </div>

      <h3>D√©tail par source</h3>

      {% if result.table and result.table|length > 0 %}
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>Source</th>
              <th>% d‚Äôutilisation</th>
              <th>M√©diane (gCO‚ÇÇ/kWh)</th>
              <th>Contribution (gCO‚ÇÇ/kWh)</th>
            </tr>
          </thead>
          <tbody>
            {% for row in result.table %}
            <tr>
              <td>{{ row.source }}</td>
              <td>{{ "%.2f"|format(row.pct) }}%</td>
              <td>{{ row.median }}</td>
              <td>{{ "%.2f"|format(row.contrib) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="empty">Aucun d√©tail disponible pour cette s√©lection.</div>
      {% endif %}

      <p class="note">
        contribution = (%/100) √ó facteur. Total = somme des contributions.<br />
        Annuel = (kgCO‚ÇÇ/kWh) √ó (kW √ó 24 √ó 365). Arbres = kg/an √∑ 25.
      </p>
    </section>
    {% endif %}

    <footer class="footer">
      <p>
        La table <code>World</code> est d√©riv√©e (moyenne du mix des pays regroup√©s par continent via
        <code>hello_dbms.world</code>).
      </p>
    </footer>
  </main>
</body>

</html>